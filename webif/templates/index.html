{% extends "base_plugin.html" %}
{% set tabcount = 3 %}
{% set tab1title = _('Viessmann Items') %}
{% set tab2title = _('Aktive Datenpunkte') %}
{% set tab3title = _('Alle Datenpunkte') %}
{% set language = p.get_sh().get_defaultlanguage() %}
{% if last_read_cmd != "" %}
{% set start_tab = 3 %}
{% endif %}
{% if language not in ['en','de'] %}
{% set language = 'en' %}
{% endif %}

{% block pluginscripts %}
{#
<script>
    function handleUpdatedData(response, dataSet = null) {
        if (dataSet === null) {
            var response = JSON.parse(response);

            // set last read data in header block
            var last = response['last'];
            var last_str = "";
            if (last['cmd'] != "") {
            	last_str = last['cmd'] + ": ";
            } else {
            	last_str = "---";
            }
            shngInsertText('last_read_cmd', last_str )
            shngInsertText('last_read_val', last['val'])

            // set appropriate value in tab3
            var elem = "addr" + last['addr']
            shngInsertText(elem, last['val'])
        }
    }
</script>

#}

/*
 * The combined file was created by the DataTables downloader builder:
 *   https://datatables.net/download
 *
 * To rebuild or modify this file with the latest versions of the included
 * software please visit:
 *   https://datatables.net/download/#dt/dt-1.10.21/fh-3.1.7/r-2.2.5
 *
 * Included libraries:
 *   DataTables 1.10.21, FixedHeader 3.1.7, Responsive 2.2.5
 */
<link rel="stylesheet" type="text/css" href="static/datatables.css">
<script type="text/javascript" charset="utf8" src="static/datatables.js"></script>

<script>
$(document).ready( function () {
    $('#itemtable').DataTable( {
        "paging": false,
        fixedHeader: true
        } );
    $('#activetable').DataTable( {
        "paging": false,
        fixedHeader: true
        } );
    $('#addrtable').DataTable( {
    	"paging": false,
    	fixedHeader: true
    	} );
} );
</script>
{% endblock pluginscripts %}

{% block headtable %}
<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<td class="py-1"><strong>{{ _('Serieller Port') }}</strong></td>
			<td class="py-1">{{ p._serialport }}</td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>{{ _('Anzahl Items') }}</strong></td>
			<td class="py-1">{{ p._params|length }}</td>
			<td class="py-1" width="50px"></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Heizungstyp') }}</strong></td>
			<td class="py-1">{{ p._heating_type }}</td>
			<td></td>
			<td class="py-1"><strong>{{ _('Verbunden') }}</strong></td>
			<td class="py-1">{{ p._connected }}</td>
			<td></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Protokoll') }}</strong></td>
			<td class="py-1">{{ p._protocol }}</td>
			<td></td>
			<td class="py-1"><strong>{{ _('Verbindung aktiv') }}</strong></td>
			<td class="py-1">{{ p._initialized }}</td>
			<td></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Letzter manuell gelesener Wert') }}</strong></td>
			<td class="py-1" colspan="4">
				<span id="last_read_cmd">{{ last_read_cmd + ": " if last_read_cmd else '---' }} </span> <span id="last_read_val">{{ last_read_value }}</span>
			</td>
			<td></td>
		</tr>
	</tbody>
</table>
{% endblock headtable %}

{% block bodytab1 %}
<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
	<div class="col-sm-12">
		{% if p._params|length %}
		    <table id="itemtable" class="table table-striped table-hover">
		    	<thead>
				    <tr>
				    	<th>{{ _('Item') }}</th>
				    	<th>{{ _('Datenpunkt') }}</th>
				    	<th>{{ _('Befehlsname') }}</th>
				    	<th>{{ _('Typ') }}</th>
				    	<th>{{ _('Wert') }}</th>
				    	<th>{{ _('Letzte Aktualisierung') }}</th>
				    </tr>
				</thead>
				<tbody>
				    {% for commandcode in p._params %}
				        <tr>
				            <td>{{ p._params[commandcode]['item'].path() }}</td>
				            <td>{{ commandcode }}</td>
				            <td>{{ p._params[commandcode]['commandname'] }}</td>
				            <td>{{ p._params[commandcode]['item'].type() }}</td>
				            <td>{{ p._params[commandcode]['item']() }}</td>
				            <td>{{ p._params[commandcode]['item'].last_update() }}</td>
				        </tr>
				    {% endfor %}
				</tbody>
		    </table>
		{% endif %}
	</div>
</div>
{% endblock bodytab1 %}

{% block bodytab2 %}
<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
	<div class="col-sm-12">
		{% if p._params|length %}
		    <table id="activetable" class="table table-striped table-hover">
			    <thead>
				    <tr>
				    	<th>{{ _('Datenpunkt') }}</th>
				    	<th>{{ _('Befehlsname') }}</th>
				    	<th>{{ _('Item') }}</th>
				    	<th>{{ _('Wert') }}</th>
				    	<th>{{ _('Letzte Aktualisierung') }}</th>
				   	</tr>
				</thead>
				<tbody>
					{% for commandcode in p._params %}
				        <tr>
				            <td>{{ commandcode }}</td>
				            <td>{{ p._params[commandcode]['commandname'] }}</td>
				            <td>{{ p._params[commandcode]['item'].path() }}</td>
				            <td>{{ p._params[commandcode]['item']() }}</td>
				            <td>{{ p._params[commandcode]['item'].last_update() }}</td>
				        </tr>
				    {% endfor %}
				</tbody>
		    </table>
		{% endif %}
	</div>
</div>
{% endblock bodytab2 %}

{% block bodytab3 %}
<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
	<div class="col-sm-12">
		{% if cmds|length %}
			<form id="button_pressed" action="button_pressed" method="post">
				<input type="hidden" id="button" name="button" value="" />
			    <table id="addrtable" class="table table-striped table-hover">
				    <thead>
					    <tr>
					    	<th>{{ _('Befehlsname') }}</th>
					    	<th>{{ _('Datenpunkt') }}</th>
					    	<th>{{ _('LÃ¤nge') }}</th>
					    	<th>{{ _('Einheit') }}</th>
					    	<th>{{ _('Lesen/Schreiben') }}</th>
					    	<th>{{ _('Datenpunkt lesen') }}</th>
					   	</tr>
					</thead>
					<tbody>
					    {% for cmd in cmds.keys() %}
					        <tr>
					            <td>{{ cmd }}</td>
					            <td>{{ cmds[cmd]['addr'] }}</td>
					            <td>{{ cmds[cmd]['len'] }}</td>
					            <td>{{ cmds[cmd]['unit'] }}</td>
					            <td>{{ cmds[cmd]['set'] }}</td>
					            <td>
					            		<button class="btn btn-shng btn-sm" type="button" onclick="$('#button').val('{{ cmds[cmd]['addr'] }}');$('#button_pressed').submit();">lesen</button>
					            		<span id="addr{{ cmds[cmd]['addr'] }}">&nbsp;</span>
					            </td>
					        </tr>
					    {% endfor %}
					</tbody>
			    </table>
        	</form>
		{% endif %}
	</div>
</div>
{% endblock bodytab3 %}
